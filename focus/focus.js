(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/focus/focus"],{2301:function(t,e,n){"use strict";(function(t){var a=n("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=a(n("7eb4")),o=a(n("7ca3")),r=a(n("ee10")),s=n("2953"),c=n("0734");function u(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function l(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?u(Object(n),!0).forEach((function(e){(0,o.default)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var h={components:{},data:function(){return{queryData:{},remainingTime:0,crystalRate:0,quotes:[{text:"专注是最大的力量",author:"爱因斯坦"},{text:"把时间花在你真正在意的事情上",author:"史蒂夫·乔布斯"},{text:"一次只做一件事，把它做到最好",author:"马克·吐温"},{text:"专注的心智，就是最好的修行",author:"稻盛和夫"},{text:"把注意力放在当下，就是最好的礼物",author:"老子"}],currentQuote:null,timerId:null,progress:0,completionReward:0,isZhuBiack:!0,hideSecond:0,hideTimerId:null,angle:0,baseAngle:0,angleDiff:0,isMonitoring:!1,overAngleStartTime:null,checkInterval:null,distance:0,initialLocation:null,locationTimer:null,distanceThreshold:60,innerAudioContext:null,autoStartBreak:!1,showRestModal:!1,restTime:0,restTimeId:null,speed:1,isMuch:!1,useType:0,focusId:0}},onHide:function(){clearInterval(this.timerId),this.$tool.set("HIDETIME",Date.now()),this.setStorage()},created:function(){this.$tool.remove("HIDETIME")},onShareAppMessage:function(){var t=this;return{title:"快来一起见证我专注情况吧！",path:"/pages/viewFocus/viewFocus?id=".concat(this.focusId),complete:function(){t.$tool.toast("分享成功")}}},onShow:function(){var e=this;this.$tool.setTheme(this.$store.state.currTheme.colors.primary);var n=this.$tool.get("HIDETIME");if(n){clearInterval(this.hideTimerId);var a=Date.now(),o=this.getTimeDiffInSeconds(a,n);this.$tool.remove("HIDETIME"),o>0&&o<30&&this.$tool.modal("提醒","检测到您已离开页面".concat(o,"秒，超过30秒自动失败，确认后恢复继续专注"),!1,(function(){e.startTimer()})),o>=30&&(this.$tool.showLoading(),this.isZhuBiack=!1,(0,s.busFocusShowUpdate)({id:this.focusId,progress:this.progress,status:4,focusTime:this.remainingTime,reason:"检测到您已离开页面".concat(o,"秒，专注失败")}),(0,s.busUserFocusFail)({minutes:60*this.queryData.minutes-this.remainingTime}).then(function(){var n=(0,r.default)(i.default.mark((function n(a){return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,e.$store.dispatch("getUserInfo");case 2:return t.hideLoading(),e.isZhuBiack=!1,n.next=6,e.$store.dispatch("getUserInfo");case 6:t.hideLoading(),2==a.result?e.$tool.modal("专注失败","检测到您已离开页面".concat(o,"秒，专注失败，下次请保持专注。自动使用专注护盾道具免除一次专注失败，请下次再接再厉！"),!1,(function(){t.navigateBack()})):5==a.result?e.$tool.modal("专注失败","检测到您已离开页面".concat(o,"秒，专注失败，下次请保持专注。自动使用时间暂停道具，本次失败不进入统计哦！"),!1,(function(){t.navigateBack()})):e.$tool.modal("专注失败","检测到您已离开页面".concat(o,"秒，专注失败，下次请保持专注"),!1,(function(){t.navigateBack()})),e.setStorage();case 9:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}()))}var c=this.$tool.get("SETTINGS");c.soundIndex>0&&setTimeout((function(){var t="/static/mp3/".concat(c.soundIndex,".mp3");e.palyMusic(t)}),1e3)},onUnload:function(e){var n=this;this.stopMonitor(),this.stopLocationMonitor(),null!=this.innerAudioContext&&this.innerAudioContext.stop(),this.isZhuBiack&&(this.setStorage(),this.clearMonitoring(),t.showModal({title:"提示",content:"检测到您离开页面了，这样会导致专注失败，是否继续专注？",confirmText:"结束专注",confirmColor:"#FF4D4F",cancelText:"继续专注",success:function(e){e.confirm?((0,s.busFocusShowUpdate)({id:n.focusId,progress:n.progress,status:4,focusTime:n.remainingTime,reason:"离开页面导致专注失败"}),n.$tool.showLoading(),(0,s.busUserFocusFail)({minutes:60*n.queryData.minutes-n.remainingTime}).then(function(){var e=(0,r.default)(i.default.mark((function e(a){return i.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n.isZhuBiack=!1,e.next=3,n.$store.dispatch("getUserInfo");case 3:t.hideLoading(),2==a.result?n.$tool.modal("专注失败","自动使用专注护盾道具免除一次专注失败，请下次再接再厉！",!1,(function(){t.navigateBack()})):5==a.result?n.$tool.modal("专注失败","自动使用时间暂停道具，本次失败不进入统计哦！",!1,(function(){t.navigateBack()})):t.navigateBack(),n.setStorage();case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())):n.$tool.href("/pages/focus/focus?cache=1")}}))},onLoad:function(){var e=this;return(0,r.default)(i.default.mark((function n(){var a,o,r,u,h,d,f;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(a=!1,e.clearMonitoring(),o=e.$Route.query,!e.$tool.getHasOwn(o,"cache")){n.next=11;break}r=e.getStorage(),e.queryData=r.queryData,e.currentQuote=r.currentQuote,e.remainingTime=r.remainingTime,e.focusId=r.focusId,n.next=37;break;case 11:if(e.queryData=JSON.parse(decodeURIComponent(o.str)),e.$tool.showLoading(),t.hideLoading(),!(null!=e.queryData.typeList&&e.queryData.typeList.length>0)){n.next=20;break}return e.$tool.showLoading(),n.next=18,(0,c.busFocusPropUseProp)({typeList:e.queryData.typeList}).catch((function(n){console.log(n),t.hideLoading(),e.isZhuBiack=!1,a=!0,e.$tool.modal("提示",n.data.message,!1,(function(){e.$tool.back()}))}));case 18:n.sent,t.hideLoading();case 20:if(!e.queryData.typeList.includes(6)){n.next=34;break}if(u=e.getStorage(),console.log(u,"failCache"),u){n.next=28;break}return e.$tool.modal("提示","未获取上次专注失败信息无法回溯！",!1,(function(){e.$tool.back()})),n.abrupt("return",!1);case 28:e.queryData=u.queryData,e.progress=u.progress,e.currentQuote=u.currentQuote,e.remainingTime=u.remainingTime;case 32:n.next=37;break;case 34:h=Math.floor(Math.random()*e.quotes.length),e.currentQuote=e.quotes[h],e.remainingTime=60*e.queryData.minutes;case 37:if(null!=e.queryData.typeList&&e.queryData.typeList.length>0&&e.queryData.typeList.includes(1)&&(e.speed=1.5),a){n.next=51;break}if(e.calculateCrystalRate(),0!=e.focusId){n.next=46;break}return d={focusProgress:e.userInfo.focusProgress,progress:"0",focusTime:60*e.queryData.minutes,quotes:e.currentQuote.text,desc:e.currentQuote.author,status:0,reason:"",crystalRate:e.crystalRate,textData:JSON.stringify(l(l({},e.queryData),{},{speed:e.speed,isMuch:e.isMuch,crystalRate:e.crystalRate}))},n.next=44,(0,s.busFocusShowAdd)(d);case 44:f=n.sent,e.focusId=f.result;case 46:e.startTimer(),e.queryData.locationEnabled&&e.startLocationMonitor(),e.queryData.attitudeEnabled&&e.startMonitor(),t.setKeepScreenOn({keepScreenOn:!0}),e.restTime=60*e.queryData.selectedBreak;case 51:case"end":return n.stop()}}),n)})))()},methods:{palyMusic:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;null!=this.innerAudioContext&&this.innerAudioContext.stop();var a=t.createInnerAudioContext();a.autoplay=!0,a.src=e,a.onPlay((function(){})),a.onEnded((function(){0==n&&(a.seek(0),a.play())})),a.onError((function(t){})),this.innerAudioContext=a},getTimeDiffInSeconds:function(t,e){var n=Number(t),a=Number(e);return Math.abs(Math.floor((n-a)/1e3))},setStorage:function(){this.$tool.set("FAILCACHE",{queryData:this.queryData,progress:this.progress,remainingTime:this.remainingTime,currentQuote:this.currentQuote,focusId:this.focusId})},getStorage:function(){return this.$tool.get("FAILCACHE")},formatTime:function(t){var e=Math.floor(t/60),n=t%60;return"".concat(e.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"))},calculateCrystalRate:function(){var t=1;this.queryData.locationEnabled&&(t*=1.2),this.queryData.attitudeEnabled&&(t*=1.2),null!=this.queryData.typeList&&this.queryData.typeList.length>0&&(this.queryData.typeList.includes(3)&&(t*=2,this.isMuch=!0),this.queryData.typeList.includes(4)&&(t+=.3,this.isMuch=!0)),this.crystalRate=parseFloat(t.toFixed(2))},startTimer:function(){var t=this;this.timerId=setInterval((function(){if(t.remainingTime<=0)t.handleFocusComplete();else{var e=t.remainingTime-1,n=100*(1-e/(60*t.queryData.minutes));if(t.remainingTime=e,t.progress=n,(0,s.busFocusShowUpdate)({id:t.focusId,progress:t.progress,status:0,focusTime:t.remainingTime,reason:""}),t.queryData.autoBreak){var a=60*t.queryData.minutes-e;60==a&&t.startRest()}}}),1e3/this.speed)},startRest:function(){var t=this;this.clearMonitoring(),this.stopMonitor(),this.stopLocationMonitor(),this.showRestModal=!0;this.palyMusic("/static/mp3/rest_start.mp3",1),(0,s.busFocusShowUpdate)({id:this.focusId,progress:this.progress,status:1,focusTime:this.remainingTime,reason:""}),this.restTimeId=setInterval((function(){if(t.restTime-=1,0==t.restTime){t.palyMusic("/static/mp3/rest_end.mp3",1),t.skipRest(),clearInterval(t.restTimeId)}}),1e3)},skipRest:function(){var t=this;(0,s.busFocusShowUpdate)({id:this.focusId,progress:this.progress,status:0,focusTime:this.remainingTime,reason:""}),this.showRestModal=!1,clearInterval(this.restTimeId),this.startTimer(),this.queryData.locationEnabled&&this.startLocationMonitor(),this.queryData.attitudeEnabled&&this.startMonitor();var e=this.$tool.get("SETTINGS");e.soundIndex>0&&setTimeout((function(){var n="/static/mp3/".concat(e.soundIndex,".mp3");t.palyMusic(n)}),3e3)},handleFocusComplete:function(){var e=this;this.clearMonitoring();var n=60*this.queryData.minutes,a=Math.max(1,Math.floor(.1*n));this.completionReward=Math.max(1,Math.round(a*(this.userInfo.focusProgress/100)*this.crystalRate)),this.$tool.showLoading(),(0,s.busUserFocus)({completionReward:this.completionReward,minutes:this.queryData.minutes}).then(function(){var n=(0,r.default)(i.default.mark((function n(a){return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,e.$store.dispatch("getUserInfo");case 2:t.hideLoading(),e.isZhuBiack=!1,a.result?("/static/mp3/wan.mp3",e.palyMusic("/static/mp3/wan.mp3",1),e.$tool.modal("专注成功","获得 ".concat(e.completionReward," 晶石\n专注度提升至 ").concat(e.userInfo.focusProgress,"%\n您解锁了一个新成就，获得了晶石奖励，是否前往查看？"),!0,(function(t){t?e.$tool.href("pages/achievements/achievements",2):e.$tool.back()}))):e.$tool.modal("专注成功","获得 ".concat(e.completionReward," 晶石\n专注度提升至 ").concat(e.userInfo.focusProgress,"%"),!1,(function(t){e.$tool.back()})),(0,s.busFocusShowUpdate)({id:e.focusId,progress:e.progress,status:3,focusTime:e.remainingTime,reason:""});case 6:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}())},clearMonitoring:function(){clearInterval(this.restTimeId),clearInterval(this.timerId),clearInterval(this.hideTimerId)},toggleFocus:function(){var e=this;clearInterval(this.timerId),(0,s.busFocusShowUpdate)({id:this.focusId,progress:this.progress,status:1,focusTime:this.remainingTime,reason:"暂停专注"}),t.showModal({title:"暂停专注",content:"暂停专注将视为专注失败，确定要结束当前专注吗？",confirmText:"结束专注",confirmColor:"#FF4D4F",cancelText:"继续专注",success:function(n){n.confirm?(e.$tool.showLoading(),(0,s.busFocusShowUpdate)({id:e.focusId,progress:e.progress,status:4,focusTime:e.remainingTime,reason:"手动结束专注"}),(0,s.busUserFocusFail)({minutes:60*e.queryData.minutes-e.remainingTime}).then(function(){var n=(0,r.default)(i.default.mark((function n(a){return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return e.isZhuBiack=!1,n.next=3,e.$store.dispatch("getUserInfo");case 3:t.hideLoading(),2==a.result?e.$tool.modal("专注失败","自动使用专注护盾道具免除一次专注失败，请下次再接再厉！",!1,(function(){t.navigateBack()})):5==a.result?e.$tool.modal("专注失败","自动使用时间暂停道具，本次失败不进入统计哦！",!1,(function(){t.navigateBack()})):t.navigateBack(),e.setStorage();case 6:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}())):e.startTimer()}})},startMonitor:function(){var e=this;if(!this.isMonitoring){this.isMonitoring=!0,this.overAngleStartTime=null,this.baseAngle=null,this.angleDiff=0,t.startAccelerometer({interval:"normal",success:function(){console.log("加速度监听已启动")}});t.onAccelerometerChange((function n(a){var i=e.calculateAngle(a);e.baseAngle=i,e.angle=i,e.angleDiff=0,t.offAccelerometerChange(n),t.onAccelerometerChange(e.handleAccelerometerChange)})),this.checkInterval=setInterval(this.checkAngleDuration,500)}},stopMonitor:function(){this.isMonitoring=!1,clearInterval(this.checkInterval),t.stopAccelerometer(),t.offAccelerometerChange(this.handleAccelerometerChange)},handleAccelerometerChange:function(t){var e=this.calculateAngle(t);this.angle=e,null!==this.baseAngle&&(this.angleDiff=Math.abs(e-this.baseAngle))},calculateAngle:function(t){var e=t.x,n=t.y,a=t.z;return Math.acos(n/Math.sqrt(e*e+n*n+a*a))*(180/Math.PI)},checkAngleDuration:function(){if(null!==this.baseAngle&&null!==this.angleDiff)if(this.angleDiff>50)if(this.overAngleStartTime){var t=(Date.now()-this.overAngleStartTime)/1e3;t>=35&&(this.remindUser("专注失败，检测到您手机倾斜角度超过50度持续30秒!"),this.overAngleStartTime=null)}else this.overAngleStartTime=Date.now();else this.overAngleStartTime=null},remindUser:function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";t.vibrateLong(),this.stopMonitor(),this.stopLocationMonitor(),this.setStorage(),this.clearMonitoring(),this.isZhuBiack=!1,(0,s.busFocusShowUpdate)({id:this.focusId,progress:this.progress,status:4,focusTime:this.remainingTime,reason:n}),(0,s.busUserFocusFail)({minutes:60*this.queryData.minutes-this.remainingTime}).then(function(){var a=(0,r.default)(i.default.mark((function a(o){return i.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,e.$store.dispatch("getUserInfo");case 2:2==o.result?e.$tool.modal("专注失败","".concat(n,"。自动使用专注护盾道具免除一次专注失败，请下次再接再厉！"),!1,(function(){t.navigateBack()})):5==o.result?e.$tool.modal("专注失败","".concat(n,"。自动使用时间暂停道具，本次失败不进入统计哦！"),!1,(function(){t.navigateBack()})):e.$tool.modal("专注失败",n,!1,(function(t){e.$tool.back()})),e.setStorage();case 4:case"end":return a.stop()}}),a)})));return function(t){return a.apply(this,arguments)}}())},startLocationMonitor:function(){var e=this;this.locationTimer||t.getLocation({type:"wgs84",isHighAccuracy:!0,success:function(n){e.initialLocation={latitude:n.latitude,longitude:n.longitude},e.locationTimer=setInterval((function(){t.getLocation({type:"wgs84",isHighAccuracy:!0,success:function(t){e.distance=e.calcDistance(e.initialLocation.latitude,e.initialLocation.longitude,t.latitude,t.longitude),e.distance>e.distanceThreshold&&(clearInterval(e.locationTimer),e.remindUser("专注失败，检测到您距离起始点已超过30米了!"))}})}),1e3)}})},stopLocationMonitor:function(){this.locationTimer&&(clearInterval(this.locationTimer),this.locationTimer=null,this.initialLocation=null)},calcDistance:function(t,e,n,a){var i=function(t){return t*Math.PI/180},o=i(n-t),r=i(a-e),s=Math.pow(Math.sin(o/2),2)+Math.cos(i(t))*Math.cos(i(n))*Math.pow(Math.sin(r/2),2),c=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return 6371e3*c}}};e.default=h}).call(this,n("df3c")["default"])},"2af8":function(t,e,n){},"56ec":function(t,e,n){"use strict";(function(t,e){var a=n("47a9");n("f244");a(n("3240"));var i=a(n("a31f"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(i.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},"73cc":function(t,e,n){"use strict";n.r(e);var a=n("2301"),i=n.n(a);for(var o in a)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return a[t]}))}(o);e["default"]=i.a},"99ea":function(t,e,n){"use strict";var a=n("2af8"),i=n.n(a);i.a},a31f:function(t,e,n){"use strict";n.r(e);var a=n("b010"),i=n("73cc");for(var o in i)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(o);n("99ea");var r=n("828b"),s=Object(r["a"])(i["default"],a["b"],a["c"],!1,null,"89f5dfdc",null,!1,a["a"],void 0);e["default"]=s.exports},b010:function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){return a}));var a={themeBackground:function(){return Promise.all([n.e("common/vendor"),n.e("components/theme-background/theme-background")]).then(n.bind(null,"327d"))}},i=function(){var t=this,e=t.$createElement,n=(t._self._c,t.formatTime(t.remainingTime)),a=(t.queryData.locationEnabled||t.queryData.attitudeEnabled)&&t.queryData.locationEnabled?t.distance.toFixed(1):null,i=(t.queryData.locationEnabled||t.queryData.attitudeEnabled)&&t.queryData.attitudeEnabled?t.angleDiff.toFixed(1):null,o=t.showRestModal?t.formatTime(t.restTime):null;t.$mp.data=Object.assign({},{$root:{m0:n,g0:a,g1:i,m1:o}})},o=[]}},[["56ec","common/runtime","common/vendor"]]]);